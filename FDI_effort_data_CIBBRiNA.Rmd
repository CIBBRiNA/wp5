
```{r title, include = FALSE}
front_title <- "DRAFT - FDI effort data CIBBRiNA"
```

<!-- The output directory below defines the path the html file will be saved at -->

---
title: `r front_title`
date: "`r format(Sys.time(), '%d %B, %Y')`"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4),".html"), 
  output_dir = "Q:/20-forskning/20-dfad/users/joeg/home/VMS/250318_CIBBRiNA/html")})
output:
  html_document
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen=999)
```


```{r libraries}
library(tidyr)
library(dplyr)
library(stringr)
library(ggplot2)
library(sf)
```

```{r source, message = FALSE, warning = FALSE}
datapath <- "Q:\\20-forskning\\20-dfad\\data\\Data\\FDI_data_dissemination\\2024 DC\\"

# Read FDI effort data
effort_MS <- read.csv(paste(datapath,"2024_fdi_effort\\Effort\\FDI Effort by country.csv",sep=''))
effort_EU <- read.csv(paste(datapath,"2024_fdi_effort\\Effort\\FDI Effort EU.csv",sep=""))
effort_rect <- read.csv(paste(datapath, "spatial_effort_tableau_pts_EU27.csv", sep=""))

# Area
effort_EU$area <- tolower(effort_EU$Sub.region)
effort_MS$area <- tolower(effort_MS$Sub.region)
effort_rect$area <- tolower(effort_rect$sub_region)

# Gear
effort_EU$gear_lvl4 <- substr(effort_EU$Metier, 1,3)
effort_MS$gear_lvl4 <- substr(effort_MS$Metier, 1,3)
effort_rect$gear_lvl4 <- substr(effort_rect$metier, 1,3)

# metier level 5
effort_EU$metier_lvl5 <- substr(effort_EU$Metier, 1,7)
effort_MS$metier_lvl5 <- substr(effort_MS$Metier, 1,7)
effort_rect$metier_lvl5 <- substr(effort_rect$metier, 1,7)

#Vessel length grouped
effort_EU$VL_GR <- effort_EU$Vessel.Length.Category
effort_EU$VL_GR[effort_EU$VL_GR %in% c("VL0006", "VL0008", "VL0010", "VL0612", "VL0812", "VL1012")] <- 'VL0012'
effort_MS$VL_GR <- effort_MS$Vessel.Length.Category
effort_MS$VL_GR[effort_MS$VL_GR %in% c("VL0006", "VL0008", "VL0010", "VL0612", "VL0812", "VL1012")] <- 'VL0012'

#Area shapefile

area <- st_read("Q:\\20-forskning\\12-gis\\Dynamisk\\GEOdata2020\\BasicLayers\\Boundaries\\ICES\\ICES_Areas_20160601_cut_dense_3857.shp", quiet = TRUE)

area$area <- area$Area_Full
area <- subset(area, select=c(area, geometry))
area$area[area$area %in% c("27.10.a.1", "27.10.a.2")] <- "27.10.a"
area$area[area$area %in% c("27.5.a.1", "27.5.a.2")] <- "27.5.a"
area$area[area$area %in% c("27.6.b.1", "27.6.b.2")] <- "27.6.b"
area$area[area$area %in% c("27.7.c.1", "27.7.c.2")] <- "27.7.c"

area2 <- area %>%
  group_by(area) %>%
  summarise(geometry = st_union(geometry), .groups = "drop") %>%
  st_as_sf()

#Rectangle shapefile
rect <- st_read("Q:\\20-forskning\\12-gis\\Dynamisk\\GEOdata2020\\BasicLayers\\Boundaries\\ICES\\ICES_Statistical_Rectangles_Eco.shp", quiet = TRUE)

rect$icesname <- rect$ICESNAME
rect <- subset(rect, select=c(icesname, geometry))

```

## FDI effort data for CIBBRiNA

Public data from EU STECF Fisheries Dependent Information data call are downloaded from: https://stecf.ec.europa.eu/data-dissemination/fdi_en

Data are filtered to match the CIBBRiNA case studies. Only case studies where it makes sense to extract from FDI are included:

The fleet definitions should be validated by CS leads that the selection based on “country*gear*area*(deep)” is appropriate and relevant for their case study. Some may need a more precise selection — for example, by using DCF Métiers at Level 5 or 6, or by including vessel length ranges.

 * Case study 1: Northern Gillnets - included for Sweden, Denmark, Poland and Germany. Norway and Iceland does not report to the EU FDI data call
 * Case study 2: Southern Gillnets - Gillnets from Spain are included, areas 8.C and 9.A
 * Case study 3: UK static nets - UK data only available until 2020.
 * Case study 4: Deepwater longlines in Portuguese waters - Portugal - deepwater indicator DEEP
 * Case study 5: Surface longlines in Madeira waters  - included. Longlines in area 34.1.2
 * Case study 6: UK longlines - UK data only available until 2020.
 * Case study 7: Pelagic trawl fisheries - included
 * Case study 8: Demersal trawl fisheries in Greater North Sea - Belgium and the Netherlands
 


```{r fleets}

#Define case study fleets
effort_MS$CSfleet <- ''
effort_EU$CSfleet <- ''
effort_rect$CSfleet <- ''

effort_MS_conf <- effort_MS

#CS1 Northern gillnets
effort_EU$CSfleet[effort_EU$gear_lvl4 %in% c("GNC","GND","GNS","GTR","GTN") & effort_EU$area %in% c("27.5.a","27.4.a","27.4.b","27.4.c","27.3.a.20","27.3.a.21","27.3.b.23","27.3.c.22","27.3.d.24","27.3.d.25","27.3.d.26")] <- 'CS1_Gillnet_North'

effort_MS_conf$CSfleet[effort_MS_conf$gear_lvl4 %in% c("GNC","GND","GNS","GTR","GTN") & effort_MS_conf$area %in% c("27.5.a","27.4.a","27.4.b","27.4.c","27.3.a.20","27.3.a.21","27.3.b.23","27.3.c.22","27.3.d.24","27.3.d.25","27.3.d.26")] <- 'CS1_Gillnet_North'

effort_MS$CSfleet[effort_MS$gear_lvl4 %in% c("GNC","GND","GNS","GTR","GTN") & effort_MS$area %in% c("27.5.a","27.4.a","27.4.b","27.4.c","27.3.a.20","27.3.a.21","27.3.b.23","27.3.c.22","27.3.d.24","27.3.d.25","27.3.d.26") & effort_MS$Country %in% c("Denmark","Sweden","Poland","Germany")] <- 'CS1_Gillnet_North'

effort_rect$CSfleet[effort_rect$gear_lvl4 %in% c("GNC","GND","GNS","GTR","GTN") & effort_rect$area %in% c("27.5.a","27.4.a","27.4.b","27.4.c","27.3.a.20","27.3.a.21","27.3.b.23","27.3.c.22","27.3.d.24","27.3.d.25","27.3.d.26")] <- 'CS1_Gillnet_North'


#CS2 Southern gillnets
effort_EU$CSfleet[effort_EU$Gear.Type %in% c("GNC","GND","GNS","GTR","GTN") & effort_EU$area %in% c("27.8.c","27.9.a")] <- 'CS2_Gillnet_South'

effort_MS_conf$CSfleet[effort_MS_conf$Gear.Type %in% c("GNC","GND","GNS","GTR","GTN") & effort_MS_conf$area %in% c("27.8.c","27.9.a")] <- 'CS2_Gillnet_South'

effort_MS$CSfleet[effort_MS$Gear.Type %in% c("GNC","GND","GNS","GTR","GTN") & effort_MS$area %in% c("27.8.c","27.9.a") & effort_MS$Country %in% c("Spain")] <- 'CS2_Gillnet_South'

effort_rect$CSfleet[effort_rect$gear_type %in% c("GNC","GND","GNS","GTR","GTN") & effort_rect$area %in% c("27.8.c","27.9.a")] <- 'CS2_Gillnet_South'

#CS3 UK static nets - missing UK
effort_MS$CSfleet[effort_MS$Gear.Type %in% c("GNC","GND","GNS","GTR","GTN") & effort_MS$Country=='United Kingdom'] <- 'CS3_Gillnet_UK'

#CS4 Deepwater longlines in portuguese waters
effort_MS$CSfleet[effort_MS$Gear.Type %in% c("LHP","LLD","LLS") & effort_MS$Country=='Portugal' & !(is.na(effort_MS$Deep)) & effort_MS$area %in% c("34.1.2","27.10.a","27.9.a" )] <- 'CS4_Longlines_DEEP_PRT'

effort_MS_conf$CSfleet[effort_MS_conf$Gear.Type %in% c("LHP","LLD","LLS") & !(is.na(effort_MS_conf$Deep)) & effort_MS_conf$area %in% c("34.1.2","27.10.a","27.9.a" )] <- 'CS4_Longlines_DEEP_PRT'

effort_EU$CSfleet[effort_EU$Gear.Type %in% c("LHP","LLD","LLS") & !(is.na(effort_EU$Deep)) & effort_EU$area %in% c("34.1.2","27.10.a","27.9.a" )] <- 'CS4_Longlines_DEEP_PRT'

effort_rect$CSfleet[effort_rect$gear_type %in% c("LHP","LLD","LLS") & !(is.na(effort_rect$deep)) & effort_rect$area %in% c("34.1.2","27.10.a","27.9.a" )] <- 'CS4_Longlines_DEEP_PRT'


#CS5 Surface longlines in Madeira waters
effort_MS$CSfleet[effort_MS$Gear.Type %in% c("LHP","LLD","LLS") & effort_MS$Country=='Portugal' & is.na(effort_MS$Deep) & effort_MS$area %in% c("34.1.2" )] <- 'CS5_Surface_Longlines_Madeira'

effort_MS_conf$CSfleet[effort_MS_conf$Gear.Type %in% c("LHP","LLD","LLS") & is.na(effort_MS_conf$Deep) & effort_MS_conf$area %in% c("34.1.2" )] <- 'CS5_Surface_Longlines_Madeira'

effort_EU$CSfleet[effort_EU$Gear.Type %in% c("LHP","LLD","LLS") & is.na(effort_EU$Deep) & effort_EU$area %in% c("34.1.2")] <- 'CS5_Surface_Longlines_Madeira'

#CS6 UK longlines
effort_MS$CSfleet[effort_MS$Country=='United Kingdom' & effort_MS$Gear.Type %in% c("LHM","LHP","LLD","LLS", "LNB","LTL") & effort_MS$area %in% c("27.6.a","27.7.b","27.7.j","27.4.a")] <- 'CS6_Longlines_UK'

#CS7 Pelagic trawls
effort_MS$CSfleet[effort_MS$Country %in% c('United Kingdom','Denmark','Ireland','Netherlands') & effort_MS$Gear.Type %in% c("OTM","PTM") & effort_MS$area %in% c("27.4.a","27.4.b","27.4.c","27.6.a","27.6.b","27.7.a","27.7.b","27.7.c","27.7.d","27.7.e","27.7.f","27.7.g","27.7.h","27.7.j","27.7.k","27.8.a")] <- 'CS7_Pelagic_trawl'

effort_MS_conf$CSfleet[effort_MS_conf$Gear.Type %in% c("OTM","PTM") & effort_MS_conf$area %in% c("27.4.a","27.4.b","27.4.c","27.6.a","27.6.b","27.7.a","27.7.b","27.7.c","27.7.d","27.7.e","27.7.f","27.7.g","27.7.h","27.7.j","27.7.k","27.8.a")] <- 'CS7_Pelagic_trawl'

effort_EU$CSfleet[effort_EU$Gear.Type %in% c("OTM","PTM") & effort_EU$area %in% c("27.4.a","27.4.b","27.4.c","27.6.a","27.6.b","27.7.a","27.7.b","27.7.c","27.7.d","27.7.e","27.7.f","27.7.g","27.7.h","27.7.j","27.7.k","27.8.a")] <- 'CS7_Pelagic_trawl'

effort_rect$CSfleet[effort_rect$gear_type %in% c("OTM","PTM") & effort_rect$area %in% c("27.4.a","27.4.b","27.4.c","27.6.a","27.6.b","27.7.a","27.7.b","27.7.c","27.7.d","27.7.e","27.7.f","27.7.g","27.7.h","27.7.j","27.7.k","27.8.a")] <- 'CS7_Pelagic_trawl'

#CS8 Demersal trawls
effort_MS$CSfleet[effort_MS$Country %in% c('Belgium','Netherlands') & effort_MS$Gear.Type %in% c('OTB','PTB','TBB') & effort_MS$area %in% c("27.3.a.20","27.4.b","27.4.c","27.7.d")] <- 'CS8_Demersal_trawl'

effort_MS_conf$CSfleet[effort_MS_conf$Gear.Type %in% c('OTB','PTB','TBB') & effort_MS_conf$area %in% c("27.3.a.20","27.4.b","27.4.c","27.7.d")] <- 'CS8_Demersal_trawl'

effort_EU$CSfleet[effort_EU$Gear.Type %in% c('OTB','PTB','TBB') & effort_EU$area %in% c("27.3.a.20","27.4.b","27.4.c","27.7.d")] <- 'CS8_Demersal_trawl'

effort_rect$CSfleet[effort_rect$gear_type %in% c('OTB','PTB','TBB') & effort_rect$area %in% c("27.3.a.20","27.4.b","27.4.c","27.7.d")] <- 'CS8_Demersal_trawl'


effort_EU1 <- effort_EU %>% filter(effort_EU$CSfleet!='')
effort_MS1 <- effort_MS %>% filter(effort_MS$CSfleet!='')
effort_MS_conf1 <- effort_MS_conf %>% filter(effort_MS_conf$CSfleet!='')
effort_rect1 <- effort_rect %>% filter(effort_rect$CSfleet!='')

```

```{r Data}

#Only keep requested variables
effort_EU2 <- subset(effort_EU1, select=c(Country,Year,Quarter,area,Gear.Type, Mesh.size.range,Metier,metier_lvl5, Vessel.Length.Category,VL_GR,Total.days.at.sea,Total.Fishing.Days,Total.kW.days.at.Sea,Total.GT.days.at.sea,Total.kW.fishing.days,Total.GT.fishing.days,Hours.at.Sea,kW.hours.at.sea,GT.hours.at.sea,CSfleet))
effort_MS2 <- subset(effort_MS1, select=c(Country,Year,Quarter,area,Gear.Type, Mesh.size.range,Metier,metier_lvl5,Vessel.Length.Category,VL_GR,Total.days.at.sea,Total.Fishing.Days,Total.kW.days.at.Sea,Total.GT.days.at.sea,Total.kW.fishing.days,Total.GT.fishing.days,Hours.at.Sea,kW.hours.at.sea,GT.hours.at.sea,CSfleet))

#Effort by CS fleet and year
FDI_fleet_EU <- effort_EU2 %>%
  group_by(CSfleet, Year) %>%
  summarize(SeaDaysEU=sum(Total.days.at.sea, na.rm=T),FishingDaysEU=sum(Total.Fishing.Days, na.rm=T),
            kWSeaDaysEU=sum(Total.kW.days.at.Sea, na.rm=T), kWFishDaysEU=sum(Total.kW.fishing.days, na.rm=T))

effort_MS2$Total.days.at.sea[effort_MS2$Total.days.at.sea=='C'] <- 0
effort_MS2$Total.days.at.sea <- as.numeric(effort_MS2$Total.days.at.sea)
effort_MS2$Total.Fishing.Days[effort_MS2$Total.Fishing.Days=='C'] <- 0
effort_MS2$Total.Fishing.Days <- as.numeric(effort_MS2$Total.Fishing.Days)
effort_MS2$Total.kW.days.at.Sea[effort_MS2$Total.kW.days.at.Sea=='C'] <- 0
effort_MS2$Total.kW.days.at.Sea <- as.numeric(effort_MS2$Total.kW.days.at.Sea)
effort_MS2$Total.kW.fishing.days[effort_MS2$Total.kW.fishing.days=='C'] <- 0
effort_MS2$Total.kW.fishing.days <- as.numeric(effort_MS2$Total.kW.fishing.days)

effort_MS2$Year <- as.character(effort_MS2$Year)

FDI_fleet_MS <- effort_MS2 %>%
  group_by(CSfleet, Country, Year) %>%
  summarize(SeaDaysMS=sum(Total.days.at.sea, na.rm=T),FishingDaysMS=sum(Total.Fishing.Days, na.rm=T),
            kWSeaDaysMS=sum(Total.kW.days.at.Sea, na.rm=T), kWFishDaysMS=sum(Total.kW.fishing.days, na.rm=T))


FDI_fleet_MS_tot <- effort_MS2 %>%
  group_by(CSfleet, Year) %>%
  summarize(SeaDaysMS=sum(Total.days.at.sea, na.rm=T),FishingDaysMS=sum(Total.Fishing.Days, na.rm=T),
            kWSeaDaysMS=sum(Total.kW.days.at.Sea, na.rm=T), kWFishDaysMS=sum(Total.kW.fishing.days, na.rm=T))


FDI_fleet_join <- merge(FDI_fleet_EU, FDI_fleet_MS_tot, by=c('CSfleet','Year'))
FDI_fleet_join$FishingDaysConfidential <- FDI_fleet_join$FishingDaysEU - FDI_fleet_join$FishingDaysMS
FDI_fleet_join$SeaDaysConfidential <- FDI_fleet_join$SeaDaysEU - FDI_fleet_join$SeaDaysMS
FDI_fleet_join$kWSeaDaysConfidential <- FDI_fleet_join$kWSeaDaysEU - FDI_fleet_join$kWSeaDaysMS
FDI_fleet_join$kWFishDaysConfidential <- FDI_fleet_join$kWFishDaysEU - FDI_fleet_join$kWFishDaysMS

FDI_fleet_confidential <- subset(FDI_fleet_join, select=c(CSfleet, Year, FishingDaysConfidential, SeaDaysConfidential, kWSeaDaysConfidential, kWFishDaysConfidential))
FDI_fleet_confidential$Country <- 'Unknown'
FDI_fleet_confidential$SeaDaysMS <- FDI_fleet_confidential$SeaDaysConfidential
FDI_fleet_confidential$FishingDaysMS <- FDI_fleet_confidential$FishingDaysConfidential
FDI_fleet_confidential$kWSeaDaysMS <- FDI_fleet_confidential$kWSeaDaysConfidential
FDI_fleet_confidential$kWFishDaysMS <- FDI_fleet_confidential$kWFishDaysConfidential
FDI_fleet_confidential <- subset(FDI_fleet_confidential, select=c(CSfleet, Country, Year, SeaDaysMS, FishingDaysMS, kWSeaDaysMS, kWFishDaysMS))

FDI_fleet_confidential$Year <- as.character(FDI_fleet_confidential$Year)
FDI_fleet_MS_tot <- rbind(FDI_fleet_MS, FDI_fleet_confidential)

FDI_rows_confidential <- effort_MS_conf1
#FDI_rows_confidential$confidential[FDI_rows_confidential$Total.days.at.sea=='C'] <- 'Y'
FDI_rows_confidential$confidential <- ifelse(FDI_rows_confidential$Total.Fishing.Days=='C', 'Y', 'N')
FDI_rows_confidential$n_rows <- 1
FDI_rows_confidential$Year <- as.character(FDI_rows_confidential$Year)
FDI_rows_confidential_sum <- FDI_rows_confidential %>%
  group_by(CSfleet, Country, Year, confidential) %>%
  summarize(n_rows=sum(n_rows, na.rm=T))

country_colors <- c(
  "Sweden" = "#1f77b4",         # blue
  "Germany" = "#ff7f0e",        # orange
  "Poland" = "#2ca02c",         # green
  "Denmark" = "#d62728",        # red
  "Spain" = "#9467bd",          # purple
  "United Kingdom" = "#8c564b", # brown
  "Portugal" = "#e377c2",       # pink
  "Netherlands" = "#7f7f7f",    # gray
  "Ireland" = "#bcbd22",        # olive
  "Belgium" = "#17becf",        # cyan
  "Unknown" = "#cccccc"    # light gray

)

vessel_length_colors <- c(
  "NK"      = "#d9d9d9",  # neutral gray for unknown
  "VL0008"  = "#c6dbef",  # light blue
  "VL0010"  = "#9ecae1",  # slightly darker blue
  "VL0612"  = "#6baed6",  # medium blue
  "VL0812"  = "#4292c6",  # deeper blue
  "VL1012"  = "#2171b5",  # stronger blue
  "VL1218"  = "#08519c",  # dark blue
  "VL1824"  = "#08306b",  # very dark blue
  "VL2440"  = "#6a51a3",  # purple
  "VL40XX"  = "#4a1486"   # deep purple
)

vessel_length_colors_reduced <- c(
  "NK"      = "#d9d9d9",  # neutral gray for unknown
  "VL0012"  = "#4292c6",  # medium/deeper blue (from the 8–12 range)
  "VL1218"  = "#08519c",  # dark blue
  "VL1824"  = "#08306b",  # very dark blue
  "VL2440"  = "#6a51a3",  # purple
  "VL40XX"  = "#4a1486"   # deep purple
)
```


```{r Spatial, message = FALSE, warning = FALSE}
#Effort by CS fleet, year and area
FDI_area <- effort_EU2 %>%
  group_by(CSfleet, Year, area) %>%
  summarize(SeaDays=sum(Total.days.at.sea, na.rm=T),FishingDays=sum(Total.Fishing.Days, na.rm=T),
            kWSeaDays=sum(Total.kW.days.at.Sea, na.rm=T), kWFishDays=sum(Total.kW.fishing.days, na.rm=T))

#CS1 EU area
FDI_area_CS1_2023 <- FDI_area %>% filter(CSfleet=="CS1_Gillnet_North" & Year==2023)
FDI_area_CS1_2023_geo <- merge(FDI_area_CS1_2023, area, by="area", all.x=TRUE)
st_write(FDI_area_CS1_2023_geo, "Q:\\20-forskning\\20-dfad\\users\\joeg\\home\\VMS\\250318_CIBBRiNA\\shp\\FDI_area_CS1_2023.shp", delete_dsn = TRUE, quiet = TRUE)

#CS2 EU area
FDI_area_CS2_2023 <- FDI_area %>% filter(CSfleet=="CS2_Gillnet_South" & Year==2023)
FDI_area_CS2_2023_geo <- merge(FDI_area_CS2_2023, area, by="area", all.x=TRUE)
st_write(FDI_area_CS2_2023_geo, "Q:\\20-forskning\\20-dfad\\users\\joeg\\home\\VMS\\250318_CIBBRiNA\\shp\\FDI_area_CS2_2023.shp", delete_dsn = TRUE, quiet = TRUE)

#CS4 EU area
FDI_area_CS4_2023 <- FDI_area %>% filter(CSfleet=="CS4_Longlines_DEEP_PRT" & Year==2023)
FDI_area_CS4_2023_geo <- merge(FDI_area_CS4_2023, area, by="area", all.x=TRUE)
st_write(FDI_area_CS4_2023_geo, "Q:\\20-forskning\\20-dfad\\users\\joeg\\home\\VMS\\250318_CIBBRiNA\\shp\\FDI_area_CS4_2023.shp", delete_dsn = TRUE, quiet = TRUE)

#CS7 EU area
FDI_area_CS7_2023 <- FDI_area %>% filter(CSfleet=="CS7_Pelagic_trawl" & Year==2023)
FDI_area_CS7_2023_geo <- merge(FDI_area_CS7_2023, area, by="area", all.x=TRUE)
st_write(FDI_area_CS7_2023_geo, "Q:\\20-forskning\\20-dfad\\users\\joeg\\home\\VMS\\250318_CIBBRiNA\\shp\\FDI_area_CS7_2023.shp", delete_dsn = TRUE, quiet = TRUE)

#CS8 EU area
FDI_area_CS8_2023 <- FDI_area %>% filter(CSfleet=="CS8_Demersal_trawl" & Year==2023)
FDI_area_CS8_2023_geo <- merge(FDI_area_CS8_2023, area, by="area", all.x=TRUE)
st_write(FDI_area_CS8_2023_geo, "Q:\\20-forskning\\20-dfad\\users\\joeg\\home\\VMS\\250318_CIBBRiNA\\shp\\FDI_area_CS8_2023.shp", delete_dsn = TRUE, quiet = TRUE)

#Effort by CS fleet, year and rectangle
effort_rect2 <- effort_rect1 %>%
  group_by(CSfleet, year, icesname) %>%
  summarize(fishDays=sum(totfishdays, na.rm=T))

#Rectangle data
#CS1 EU rect
rect_CS1_2023 <- effort_rect2 %>% filter(CSfleet=="CS1_Gillnet_North" & year==2023 )
rect_CS1_2023_geo <- merge(rect_CS1_2023, rect, by="icesname", all.x=TRUE)
suppressWarnings(suppressMessages(st_write(rect_CS1_2023_geo, "Q:\\20-forskning\\20-dfad\\users\\joeg\\home\\VMS\\250318_CIBBRiNA\\shp\\FDI_rect_CS1_2023.shp", delete_dsn = TRUE, quiet = TRUE)))

#CS2 EU rect
rect_CS2_2023 <- effort_rect2 %>% filter(CSfleet=="CS2_Gillnet_South" & year==2023 )
rect_CS2_2023_geo <- merge(rect_CS2_2023, rect, by="icesname", all.x=TRUE)
suppressWarnings(suppressMessages(st_write(rect_CS2_2023_geo, "Q:\\20-forskning\\20-dfad\\users\\joeg\\home\\VMS\\250318_CIBBRiNA\\shp\\FDI_rect_CS2_2023.shp", delete_dsn = TRUE, quiet = TRUE)))

#CS4 EU rect
rect_CS4_2023 <- effort_rect2 %>% filter(CSfleet=="CS4_Longlines_DEEP_PRT" & year==2023 )
rect_CS4_2023_geo <- merge(rect_CS4_2023, rect, by="icesname", all.x=TRUE)
suppressWarnings(suppressMessages(st_write(rect_CS4_2023_geo, "Q:\\20-forskning\\20-dfad\\users\\joeg\\home\\VMS\\250318_CIBBRiNA\\shp\\FDI_rect_CS4_2023.shp", delete_dsn = TRUE, quiet = TRUE)))

#CS7 EU rect
rect_CS7_2023 <- effort_rect2 %>% filter(CSfleet=="CS7_Pelagic_trawl" & year==2023 )
rect_CS7_2023_geo <- merge(rect_CS7_2023, rect, by="icesname", all.x=TRUE)
suppressWarnings(suppressMessages(st_write(rect_CS7_2023_geo, "Q:\\20-forskning\\20-dfad\\users\\joeg\\home\\VMS\\250318_CIBBRiNA\\shp\\FDI_rect_CS7_2023.shp", delete_dsn = TRUE, quiet = TRUE)))

#CS8 EU rect
rect_CS8_2023 <- effort_rect2 %>% filter(CSfleet=="CS8_Demersal_trawl" & year==2023 )
rect_CS8_2023_geo <- merge(rect_CS8_2023, rect, by="icesname", all.x=TRUE)
suppressWarnings(suppressMessages(st_write(rect_CS8_2023_geo, "Q:\\20-forskning\\20-dfad\\users\\joeg\\home\\VMS\\250318_CIBBRiNA\\shp\\FDI_rect_CS8_2023.shp", delete_dsn = TRUE, quiet = TRUE)))

```

## CIBBRiNA Case Study 1: Northern Gillnets {.tabset}

Gears: GNC,GND,GNS,GTR,GTN

Areas: 27.5.a, 27.4.a, 27.4.b, 27.4.c, 27.3.a.20, 27.3.a.21, 27.3.b.23, 27.3.c.22, 27.3.d.24, 27.3.d.25, 27.3.d.26

Countries: Sweden, Denmark, Poland, Germany (Iceland and Norway does not report to the EU FDI data call)


### Days at sea by year

The first plot is showing the effort as Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS1DASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS1_Gillnet_North')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = SeaDaysEU / SeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = SeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$SeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS1 Northern gillnet EU", 
       x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS1_Gillnet_North')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS1 Northern gillnet EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU MS",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS1_Gillnet_North')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS1 Northern gillnet EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU MS",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### Fishing days by year


The first plot is showing the effort as Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS1FDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS1_Gillnet_North')
# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = FishingDaysEU / FishingDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = FishingDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$FishingDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS1 Northern gillnet EU", 
       x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS1_Gillnet_North')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS1 Northern gillnet EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS1_Gillnet_North')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS1 Northern gillnet EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### kW Days at sea by year

The first plot is showing the effort as kW Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS1kWDASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS1_Gillnet_North')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWSeaDaysEU / kWSeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWSeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWSeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS1 Northern gillnet EU", 
       x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS1_Gillnet_North')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS1 Northern gillnet EU MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS1_Gillnet_North')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS1 Northern gillnet EU MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### kW Fishing days by year

The first plot is showing the effort as kW Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.

```{r CS1kWFDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS1_Gillnet_North')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWFishDaysEU / kWFishDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWFishDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWFishDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS1 Northern gillnet EU", 
       x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS1_Gillnet_North')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS1 Northern gillnet EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS1_Gillnet_North')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS1 Northern gillnet EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

### N effort rows confidential

Number of rows marked as confidential by country and year in the FDI effort table (G). The CS is selected without countries to reflect the dataset that is available on EU level. 

```{r CS1nConf, fig.dim= c(6, 4)}
FDI_rows_confidential_sum1 <- FDI_rows_confidential_sum %>% filter(CSfleet=='CS1_Gillnet_North')

ggplot(FDI_rows_confidential_sum1, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col(position = "dodge") +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum1, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col() +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential stacked bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum1, aes(x = Year, y = Country, fill = n_rows)) +
  geom_tile() +
  facet_wrap(~ confidential) +
  scale_fill_viridis_c() +
  labs(title = paste("Number of rows confidential heatmap"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


ggplot(FDI_rows_confidential_sum1, aes(x = Year, y = Country, size = n_rows, color = confidential)) +
  geom_point(alpha = 0.7) +
   labs(title = paste("Number of rows confidential bubble chart"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```


### Vessel length

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.

Note that after 2021, there was a requirement to report the vessel length in group 0-8 m in the Baltic, and 0-10 m in other areas. In the other years the vessel length category to report was 0-10 m.


```{r CS1FDVL, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS1_Gillnet_North') %>% group_by(Year, Vessel.Length.Category) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = paste("FDI fleet effort - CS1 Northern gillnet EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS1_Gillnet_North') %>% group_by(Year, Country, Vessel.Length.Category) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS1 Northern gillnet by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS1 Northern gillnet by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS1 Northern Gillnet) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Vessel length grouped

In these plots the vessels below 12 m have been grouped, to avoid overlapping vesse length ranges.

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS1FDVLG, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS1_Gillnet_North') %>% group_by(Year, VL_GR) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = paste("FDI fleet effort - CS1 Northern gillnet EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS1_Gillnet_North') %>% group_by(Year, Country, VL_GR) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS1 Northern gillnet by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS1 Northern gillnet by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS1 Northern Gillnet) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```


### Metier level 6

The metier level 6 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'_'Mesh size range'_'Selection devices'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 6 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS1FDMet, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS1_Gillnet_North') %>% group_by(Year, Metier) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(Metier = ifelse(Metier %in% top_metiers, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU (Top 10 Metiers)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metiers") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS1_Gillnet_North') %>% group_by(Year, Country, Metier) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(Metier %in% top_metiersMS, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS1 Northern gillnet by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS1 Northern gillnet by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS1 Northern Gillnet) – % Fishing days by Metier",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Metier level 5

The metier level 5 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 5 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS1FDMet5, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS1_Gillnet_North') %>% group_by(Year, metier_lvl5) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(metier_lvl5 = ifelse(metier_lvl5 %in% top_metiers, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS1 Northern gillnet EU (Top 10 Metier level 5)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metier level 5") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS1_Gillnet_North') %>% group_by(Year, Country, metier_lvl5) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(metier_lvl5 %in% top_metiersMS, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS1 Northern gillnet by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS1 Northern gillnet by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS1 Northern Gillnet) – % Fishing days by Metier level 5",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Quarter

Plots of fishing days by quarter and year (first plot) and by country (second plot)

```{r CS1FDQ, fig.dim= c(6, 4)}
CS_Quarter_EU <- effort_EU2 %>% filter(CSfleet == "CS1_Gillnet_North") %>%  group_by(Year, Quarter) %>%
  summarise(FishingDaysEU = sum(Total.Fishing.Days, na.rm = TRUE), .groups = "drop")

# Plot: quarterly patterns by year
ggplot(CS_Quarter_EU, aes(x = factor(Quarter), y = FishingDaysEU, 
                          group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Quarterly FDI fishing effort (CS1 Gillnet North)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

#by MS
CS_Quarter_MS <- effort_MS2 %>% filter(CSfleet=='CS1_Gillnet_North') %>% group_by(Year, Country, Quarter) %>%
  summarise(FishingDaysMS = sum(Total.Fishing.Days, na.rm =TRUE), .groups = "drop")

ggplot(CS_Quarter_MS, aes(x = factor(Quarter), y = FishingDaysMS, group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ Country) +
  labs(
    title = "Quarterly fishing effort by country (CS1 Gillnet North)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

```

### Maps

```{r CS1area, , echo=FALSE, out.width="80%", fig.cap="FDI EU CS1 Northern gillnet effort, ICES areas (2023)"}

knitr::include_graphics("Q:/20-forskning/20-dfad/users/joeg/home/VMS/250318_CIBBRiNA/maps/CS1_FDI_EU_gillnets_2023_area.png")

```

```{r CS1rect, , echo=FALSE, out.width="80%", fig.cap="FDI EU CS1 Northern gillnet effort, ICES rectangles (2023)"}

knitr::include_graphics("Q:/20-forskning/20-dfad/users/joeg/home/VMS/250318_CIBBRiNA/maps/CS1_FDI_EU_gillnets_2023_rectangle.png")

```

## CIBBRiNA Case Study 2: Southern Gillnets {.tabset}

Gears: GNC,GND,GNS,GTR,GTN

Areas: 27.8.c, 27.9.a

Countries: Spain


### Days at sea by year

The first plot is showing the effort as Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS2DASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS2_Gillnet_South')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = SeaDaysEU / SeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = SeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$SeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS2 Southern gillnet EU", 
       x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS2_Gillnet_South')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS2 Southern gillnet EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS2 Southern gillnet EU MS",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS2_Gillnet_South')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS2 Southern gillnet EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS2 Southern gillnet EU MS",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### Fishing days by year


The first plot is showing the effort as Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS2FDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS2_Gillnet_South')
# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = FishingDaysEU / FishingDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = FishingDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$FishingDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS2 Southern gillnet EU", 
       x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS2_Gillnet_South')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS2 Southern gillnet EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS2 Southern gillnet EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS2_Gillnet_South')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS2 Southern gillnet EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS2 Southern gillnet EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

### kW Days at sea by year

The first plot is showing the effort as kW Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS2kWDASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS2_Gillnet_South')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWSeaDaysEU / kWSeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWSeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWSeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS2 Southern gillnet EU", 
       x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS2_Gillnet_South')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS2 Southern gillnet EU MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS2 Southern gillnet EU MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS2_Gillnet_South')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS2 Southern gillnet EU MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS2 Southern gillnet EU MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

### kW Fishing days by year

The first plot is showing the effort as kW Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.

```{r CS2kWFDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS2_Gillnet_South')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWFishDaysEU / kWFishDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWFishDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWFishDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS2 Southern gillnet EU", 
       x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS2_Gillnet_South')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS2 Southern gillnet EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS2 Southern gillnet EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS2_Gillnet_South')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS2 Southern gillnet EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS2 Southern gillnet EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### N effort rows confidential

Number of rows marked as confidential by country and year in the FDI effort table (G). The CS is selected without countries to reflect the dataset that is available on EU level. 

```{r CS2nConf, fig.dim= c(6, 4)}
FDI_rows_confidential_sum2 <- FDI_rows_confidential_sum %>% filter(CSfleet=='CS2_Gillnet_South')

ggplot(FDI_rows_confidential_sum2, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col(position = "dodge") +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum2, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col() +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential stacked bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum2, aes(x = Year, y = Country, fill = n_rows)) +
  geom_tile() +
  facet_wrap(~ confidential) +
  scale_fill_viridis_c() +
  labs(title = paste("Number of rows confidential heatmap"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


ggplot(FDI_rows_confidential_sum2, aes(x = Year, y = Country, size = n_rows, color = confidential)) +
  geom_point(alpha = 0.7) +
   labs(title = paste("Number of rows confidential bubble chart"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```


### Vessel length

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS2FDVL, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS2_Gillnet_South') %>% group_by(Year, Vessel.Length.Category) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = paste("FDI fleet effort - CS2 Southern gillnet EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = "FDI fleet effort - CS2 Southern gillnet EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS2_Gillnet_South') %>% group_by(Year, Country, Vessel.Length.Category) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS2 Southern gillnet by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS2 Southern gillnet by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS2 Southern Gillnet) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Vessel length grouped

In these plots the vessels below 12 m have been grouped, to avoid overlapping vesse length ranges.

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS2FDVLG, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS2_Gillnet_South') %>% group_by(Year, VL_GR) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = paste("FDI fleet effort - CS2 Southern Gillnet EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = "FDI fleet effort - CS2 Southern Gillnet EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS2_Gillnet_South') %>% group_by(Year, Country, VL_GR) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS2 Southern Gillnet by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS2 Southern Gillnet by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS2 Southern Gillnet) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Metier level 6

The metier level 6 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'_'Mesh size range'_'Selection devices'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 6 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS2FDMet, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS2_Gillnet_South') %>% group_by(Year, Metier) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(Metier = ifelse(Metier %in% top_metiers, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS2 Southern gillnet EU (Top 10 Metiers)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metiers") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS2_Gillnet_South') %>% group_by(Year, Country, Metier) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(Metier %in% top_metiersMS, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS2 Southern gillnet by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS2 Southern gillnet by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS2 Southern Gillnet) – % Fishing days by Metier",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Metier level 5

The metier level 5 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 5 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS2FDMet5, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS2_Gillnet_South') %>% group_by(Year, metier_lvl5) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(metier_lvl5 = ifelse(metier_lvl5 %in% top_metiers, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS2 Southern Gillnet EU (Top 10 Metier level 5)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metier level 5") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS2_Gillnet_South') %>% group_by(Year, Country, metier_lvl5) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(metier_lvl5 %in% top_metiersMS, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS2 Southern Gillnet by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS2 Southern Gillnet by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS2 Southern Gillnet) – % Fishing days by Metier level 5",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Quarter

Plots of fishing days by quarter and year (first plot) and by country (second plot)

```{r CS2FDQ, fig.dim= c(6, 4)}
CS_Quarter_EU <- effort_EU2 %>% filter(CSfleet == "CS2_Gillnet_South") %>%  group_by(Year, Quarter) %>%
  summarise(FishingDaysEU = sum(Total.Fishing.Days, na.rm = TRUE), .groups = "drop")

# Plot: quarterly patterns by year
ggplot(CS_Quarter_EU, aes(x = factor(Quarter), y = FishingDaysEU, 
                          group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Quarterly FDI fishing effort (CS2 Gillnet South)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

#by MS
CS_Quarter_MS <- effort_MS2 %>% filter(CSfleet=='CS2_Gillnet_South') %>% group_by(Year, Country, Quarter) %>%
  summarise(FishingDaysMS = sum(Total.Fishing.Days, na.rm =TRUE), .groups = "drop")

ggplot(CS_Quarter_MS, aes(x = factor(Quarter), y = FishingDaysMS, group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ Country) +
  labs(
    title = "Quarterly fishing effort by country (CS2 Gillnet South)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

```

### Maps

```{r CS2area, , echo=FALSE, out.width="80%", fig.cap="FDI EU CS2 Southern gillnet effort, ICES areas (2023)"}

knitr::include_graphics("Q:/20-forskning/20-dfad/users/joeg/home/VMS/250318_CIBBRiNA/maps/CS2_FDI_EU_gillnets_2023_area.png")

```

```{r CS2rect, , echo=FALSE, out.width="80%", fig.cap="FDI EU CS2 Southern gillnet effort, ICES rectangles (2023)"}

knitr::include_graphics("Q:/20-forskning/20-dfad/users/joeg/home/VMS/250318_CIBBRiNA/maps/CS2_FDI_EU_gillnets_2023_rectangle.png")

```

## CIBBRiNA Case Study 3: UK static nets {.tabset}

Gears: GNC,GND,GNS,GTR,GTN

Countries: United Kingdom

The UK CS data are only extracted for the MS level, and are only available until 2020


### Days at sea by year

The plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries and gears. 


```{r CS3DASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS3_Gillnet_UK')

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS3 UK static nets"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### Fishing days by year

The plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries and gears. 

```{r CS3FDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS3_Gillnet_UK')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS3 UK static nets"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### kW Days at sea by year

The plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries and gears. 

```{r CS3kWDASYear, fig.dim= c(6, 4)}

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS3_Gillnet_UK')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS3 UK static nets"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### kW Fishing days by year

The plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries and gears. 

```{r CS3kWFDYear, fig.dim= c(6, 4)}

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS3_Gillnet_UK')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS3 UK static nets"), x = "Year", y = "kWFishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### Vessel length

The first plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.

```{r CS3FDVL, fig.dim= c(6, 4)}
CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS3_Gillnet_UK') %>% group_by(Year, Country, Vessel.Length.Category) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS3 UK static nets by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS3 UK static nets by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS3 UK static nets) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Vessel length grouped

In these plots the vessels below 12 m have been grouped, to avoid overlapping vesse length ranges.

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS3FDVLG, fig.dim= c(6, 4)}
CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS3_Gillnet_UK') %>% group_by(Year, Country, VL_GR) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS3 UK static nets by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS3 UK static nets by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS3 UK static nets) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```


### Metier level 6

The metier level 6 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'_'Mesh size range'_'Selection devices'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 6 within CS fleet at country level. 

The second plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS3FDMet, fig.dim= c(6, 4)}
#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS3_Gillnet_UK') %>% group_by(Year, Country, Metier) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(Metier %in% top_metiersMS, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(
    title = "FDI fleet effort - CS3 UK static nets by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS3 UK static nets) – % Fishing days by Metier",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Metier level 5

The metier level 5 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 5 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS3FDMet5, fig.dim= c(6, 4)}
#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS3_Gillnet_UK') %>% group_by(Year, Country, metier_lvl5) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(metier_lvl5 %in% top_metiersMS, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS3 UK static nets by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS3 UK static nets by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS3 UK static nets) – % Fishing days by Metier level 5",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Quarter

Plots of fishing days by quarter and year (first plot) and by country (second plot)

```{r CS3FDQ, fig.dim= c(6, 4)}

#by MS
CS_Quarter_MS <- effort_MS2 %>% filter(CSfleet=='CS3_Gillnet_UK') %>% group_by(Year, Country, Quarter) %>%
  summarise(FishingDaysMS = sum(Total.Fishing.Days, na.rm =TRUE), .groups = "drop")

ggplot(CS_Quarter_MS, aes(x = factor(Quarter), y = FishingDaysMS, group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ Country) +
  labs(
    title = "Quarterly fishing effort by country (CS3 static nets UK)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

```

## CIBBRiNA Case Study 4: Deepwater longlines in Portuguese waters {.tabset}

Gears: LHP,LLD,LLS

Areas: 34.1.2,27.10.a,27.9.a

Countries: Portugal

Deepwater Indicator: DEEP


### Days at sea by year

The first plot is showing the effort as Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS4DASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = SeaDaysEU / SeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = SeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$SeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU", 
       x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MSS",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### Fishing days by year


The first plot is showing the effort as Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS4FDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')
# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = FishingDaysEU / FishingDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = FishingDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$FishingDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU", 
       x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

### kW Days at sea by year

The first plot is showing the effort as kW Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS4kWDASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWSeaDaysEU / kWSeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWSeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWSeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU", 
       x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS4 Deepwater longlines in Portuguese waters MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### kW Fishing days by year

The first plot is showing the effort as kW Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.

```{r CS4kWFDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')
# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWFishDaysEU / kWFishDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWFishDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWFishDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU", 
       x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### N effort rows confidential

Number of rows marked as confidential by country and year in the FDI effort table (G). The CS is selected without countries to reflect the dataset that is available on EU level. 

```{r CS4nConf, fig.dim= c(6, 4)}
FDI_rows_confidential_sum4 <- FDI_rows_confidential_sum %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT')

ggplot(FDI_rows_confidential_sum4, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col(position = "dodge") +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum4, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col() +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential stacked bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum4, aes(x = Year, y = Country, fill = n_rows)) +
  geom_tile() +
  facet_wrap(~ confidential) +
  scale_fill_viridis_c() +
  labs(title = paste("Number of rows confidential heatmap"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


ggplot(FDI_rows_confidential_sum4, aes(x = Year, y = Country, size = n_rows, color = confidential)) +
  geom_point(alpha = 0.7) +
   labs(title = paste("Number of rows confidential bubble chart"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```


### Vessel length

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS4FDVL, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT') %>% group_by(Year, Vessel.Length.Category) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = paste("FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT') %>% group_by(Year, Country, Vessel.Length.Category) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS4 Deepwater longlines in Portuguese waters) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Vessel length grouped

In these plots the vessels below 12 m have been grouped, to avoid overlapping vesse length ranges.

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS4FDVLG, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT') %>% group_by(Year, VL_GR) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = paste("FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT') %>% group_by(Year, Country, VL_GR) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS4 Deepwater longlines in Portuguese waters) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Metier level 6

The metier level 6 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'_'Mesh size range'_'Selection devices'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 6 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS4FDMet, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT') %>% group_by(Year, Metier) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(Metier = ifelse(Metier %in% top_metiers, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU (Top 10 Metiers)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metiers") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT') %>% group_by(Year, Country, Metier) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(Metier %in% top_metiersMS, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS4 Deepwater longlines in Portuguese waters) – % Fishing days by Metier",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Metier level 5

The metier level 5 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 5 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS4FDMet5, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT') %>% group_by(Year, metier_lvl5) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(metier_lvl5 = ifelse(metier_lvl5 %in% top_metiers, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters EU (Top 10 Metier level 5)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metier level 5") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet == "CS4_Longlines_DEEP_PRT") %>%  group_by(Year, Country, metier_lvl5) %>%
  summarise(FishingDaysMS = sum(Total.Fishing.Days, na.rm = TRUE), .groups = "drop")

# Top 10 metiers by total fishing days (no ties)
top_metiersMS <- CS_Metier_MS %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysMS, na.rm = TRUE), .groups = "drop") %>%
  slice_max(Total, n = 10, with_ties = FALSE) %>%   # ensures exactly 10
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(metier_lvl5 %in% top_metiersMS, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS4 Deepwater longlines in Portuguese waters by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS4 Deepwater longlines in Portuguese waters) – % Fishing days by Metier level 5",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Quarter

Plots of fishing days by quarter and year (first plot) and by country (second plot)

```{r CS4FDQ, fig.dim= c(6, 4)}
CS_Quarter_EU <- effort_EU2 %>% filter(CSfleet == "CS4_Longlines_DEEP_PRT") %>%  group_by(Year, Quarter) %>%
  summarise(FishingDaysEU = sum(Total.Fishing.Days, na.rm = TRUE), .groups = "drop")

# Plot: quarterly patterns by year
ggplot(CS_Quarter_EU, aes(x = factor(Quarter), y = FishingDaysEU, 
                          group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Quarterly FDI fishing effort (CS4 Deepwater longlines in Portuguese waters)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

#by MS
CS_Quarter_MS <- effort_MS2 %>% filter(CSfleet=='CS4_Longlines_DEEP_PRT') %>% group_by(Year, Country, Quarter) %>%
  summarise(FishingDaysMS = sum(Total.Fishing.Days, na.rm =TRUE), .groups = "drop")

ggplot(CS_Quarter_MS, aes(x = factor(Quarter), y = FishingDaysMS, group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ Country) +
  labs(
    title = "Quarterly fishing effort by country (CS4 Deepwater longlines in Portuguese waters)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

```

### Maps

```{r CS4area, , echo=FALSE, out.width="80%", fig.cap="FDI EU CS4 Longlines effort, ICES areas (2023)"}

knitr::include_graphics("Q:/20-forskning/20-dfad/users/joeg/home/VMS/250318_CIBBRiNA/maps/CS4_FDI_EU_longlines_2023_area.png")

```

```{r CS4rect, , echo=FALSE, out.width="80%", fig.cap="FDI EU CS4 Longlines effort, ICES rectangles (2023)"}

knitr::include_graphics("Q:/20-forskning/20-dfad/users/joeg/home/VMS/250318_CIBBRiNA/maps/CS4_FDI_EU_longlines_2023_rectangle.png")

```

## CIBBRiNA Case Study 5: Surface longlines in Madeira waters {.tabset}

Gears: LHP,LLD,LLS

Areas: 34.1.2

Countries: Portugal

Deepwater Indicator: NA


### Days at sea by year

The first plot is showing the effort as Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS5DASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = SeaDaysEU / SeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = SeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$SeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU", 
       x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### Fishing days by year


The first plot is showing the effort as Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS5FDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = FishingDaysEU / FishingDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = FishingDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$FishingDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU", 
       x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

### kW Days at sea by year

The first plot is showing the effort as kW Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS5kWDASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWSeaDaysEU / kWSeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWSeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWSeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters waters EU", 
       x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS5 Surface longlines in Madeira waters MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

### kW Fishing days by year

The first plot is showing the effort as kW Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.

```{r CS5kWFDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWFishDaysEU / kWFishDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWFishDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWFishDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU", 
       x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

### N effort rows confidential

Number of rows marked as confidential by country and year in the FDI effort table (G). The CS is selected without countries to reflect the dataset that is available on EU level. 

```{r CS5nConf, fig.dim= c(6, 4)}
FDI_rows_confidential_sum5 <- FDI_rows_confidential_sum %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira')

ggplot(FDI_rows_confidential_sum5, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col(position = "dodge") +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum5, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col() +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential stacked bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum5, aes(x = Year, y = Country, fill = n_rows)) +
  geom_tile() +
  facet_wrap(~ confidential) +
  scale_fill_viridis_c() +
  labs(title = paste("Number of rows confidential heatmap"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


ggplot(FDI_rows_confidential_sum5, aes(x = Year, y = Country, size = n_rows, color = confidential)) +
  geom_point(alpha = 0.7) +
   labs(title = paste("Number of rows confidential bubble chart"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```


### Vessel length

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS5FDVL, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira') %>% group_by(Year, Vessel.Length.Category) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = paste("FDI fleet effort - CS5 Surface longlines in Madeira waters EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira') %>% group_by(Year, Country, Vessel.Length.Category) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS5 Surface longlines in Madeira waters by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS5 Surface longlines in Madeira waters by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS5 Surface longlines in Madeira waters) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Vessel length grouped

In these plots the vessels below 12 m have been grouped, to avoid overlapping vesse length ranges.

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS5FDVLG, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira') %>% group_by(Year, VL_GR) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = paste("FDI fleet effort - CS5 Surface longlines in Madeira waters EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira') %>% group_by(Year, Country, VL_GR) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS5 Surface longlines in Madeira waters by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS5 Surface longlines in Madeira waters by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS5 Surface longlines in Madeira waters) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```


### Metier level 6

The metier level 6 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'_'Mesh size range'_'Selection devices'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 6 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS5FDMet, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira') %>% group_by(Year, Metier) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(Metier = ifelse(Metier %in% top_metiers, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU (Top 10 Metiers)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metiers") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira') %>% group_by(Year, Country, Metier) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(Metier %in% top_metiersMS, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS5 Surface longlines in Madeira waters by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS5 Surface longlines in Madeira waters by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS5 Surface longlines in Madeira waters) – % Fishing days by Metier",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Metier level 5

The metier level 5 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 5 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS5FDMet5, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira') %>% group_by(Year, metier_lvl5) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(metier_lvl5 = ifelse(metier_lvl5 %in% top_metiers, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS5 Surface longlines in Madeira waters EU (Top 10 Metier level 5)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metier level 5") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira') %>% group_by(Year, Country, metier_lvl5) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(metier_lvl5 %in% top_metiersMS, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS5 Surface longlines in Madeira waters by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS5 Surface longlines in Madeira waters by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS5 Surface longlines in Madeira waters) – % Fishing days by Metier level 5",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Quarter

Plots of fishing days by quarter and year (first plot) and by country (second plot)

```{r CS5FDQ, fig.dim= c(6, 4)}
CS_Quarter_EU <- effort_EU2 %>% filter(CSfleet == "CS5_Surface_Longlines_Madeira") %>%  group_by(Year, Quarter) %>%
  summarise(FishingDaysEU = sum(Total.Fishing.Days, na.rm = TRUE), .groups = "drop")

# Plot: quarterly patterns by year
ggplot(CS_Quarter_EU, aes(x = factor(Quarter), y = FishingDaysEU, 
                          group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Quarterly FDI fishing effort (CS5 Surface longlines in Madeira waters)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

#by MS
CS_Quarter_MS <- effort_MS2 %>% filter(CSfleet=='CS5_Surface_Longlines_Madeira') %>% group_by(Year, Country, Quarter) %>%
  summarise(FishingDaysMS = sum(Total.Fishing.Days, na.rm =TRUE), .groups = "drop")

ggplot(CS_Quarter_MS, aes(x = factor(Quarter), y = FishingDaysMS, group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ Country) +
  labs(
    title = "Quarterly fishing effort by country (CS5 Surface longlines in Madeira waters)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

```



## CIBBRiNA Case Study 6: UK longlines {.tabset}

Gears: LHM,LHP,LLD,LLS,LNB,LTL

Areas: 27.6.a,27.7.b,27.7.j,27.4.a

Countries: United Kingdom

The UK CS data are only extracted for the MS level, and are only available until 2020


### Days at sea by year

The plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries and gears. 


```{r CS6DASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS6_Longlines_UK')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS6 UK longlines"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### Fishing days by year

The plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries and gears. 

```{r CS6FDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS6_Longlines_UK')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS6 UK longlines"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### kW Days at sea by year

The plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries and gears. 

```{r CS+kWDASYear, fig.dim= c(6, 4)}

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS6_Longlines_UK')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS6 UK longlines"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### kW Fishing days by year

The plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries and gears. 

```{r CS6kWFDYear, fig.dim= c(6, 4)}

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS6_Longlines_UK')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS6 UK longlines"), x = "Year", y = "kWFishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### Vessel length

The first plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.

```{r CS6FDVL, fig.dim= c(6, 4)}
CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS6_Longlines_UK') %>% group_by(Year, Country, Vessel.Length.Category) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS6 UK longlines by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS6 UK longlines by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS6 UK longlines) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Vessel length grouped

In these plots the vessels below 12 m have been grouped, to avoid overlapping vesse length ranges.

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS6FDVLG, fig.dim= c(6, 4)}
CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS6_Longlines_UK') %>% group_by(Year, Country, VL_GR) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS6 UK longlines by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS6 UK longlines by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS6 UK longlines) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```


### Metier level 6

The metier level 6 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'_'Mesh size range'_'Selection devices'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 6 within CS fleet at country level. 

The second plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS6FDMet, fig.dim= c(6, 4)}
#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS6_Longlines_UK') %>% group_by(Year, Country, Metier) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(Metier %in% top_metiersMS, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(
    title = "FDI fleet effort - CS6 UK longlines by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS6 UK longlines) – % Fishing days by Metier",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Metier level 5

The metier level 5 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 5 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS6FDMet5, fig.dim= c(6, 4)}
#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS6_Longlines_UK') %>% group_by(Year, Country, metier_lvl5) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(metier_lvl5 %in% top_metiersMS, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS6 UK longlines by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS6 UK longlines by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS6 UK longlines) – % Fishing days by Metier level 5",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Quarter

Plots of fishing days by quarter and year (first plot) and by country (second plot)

```{r CS6FDQ, fig.dim= c(6, 4)}

#by MS
CS_Quarter_MS <- effort_MS2 %>% filter(CSfleet=='CS6_Longlines_UK') %>% group_by(Year, Country, Quarter) %>%
  summarise(FishingDaysMS = sum(Total.Fishing.Days, na.rm =TRUE), .groups = "drop")

ggplot(CS_Quarter_MS, aes(x = factor(Quarter), y = FishingDaysMS, group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ Country) +
  labs(
    title = "Quarterly fishing effort by country (CS6 UK longlines)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

```

## CIBBRiNA Case Study 7: Pelaic trawl fisheries {.tabset}

Gears: OTM, PTM

Areas: 27.4.a,27.4.b,27.4.c,27.6.a,27.6.b,27.7.a,27.7.b,27.7.c,27.7.d,27.7.e,27.7.f,27.7.g,27.7.h,27.7.j,27.7.k,27.8.a

Countries: United Kingdom,Denmark,Ireland,Netherlands


### Days at sea by year

The first plot is showing the effort as Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS7DASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS7_Pelagic_trawl')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = SeaDaysEU / SeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = SeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$SeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU", 
       x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS7_Pelagic_trawl')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS7 Pelagic trawl fisheries EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU MS",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS7_Pelagic_trawl')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS7 Pelagic trawl fisheries EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU MS",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### Fishing days by year


The first plot is showing the effort as Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS7FDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS7_Pelagic_trawl')
# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = FishingDaysEU / FishingDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = FishingDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$FishingDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU", 
       x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS7_Pelagic_trawl')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS7 Pelagic trawl fisheries EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS7_Pelagic_trawl')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS7 Pelagic trawl fisheries EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

### kW Days at sea by year

The first plot is showing the effort as kW Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS7kWDASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS7_Pelagic_trawl')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWSeaDaysEU / kWSeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWSeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWSeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU", 
       x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS7_Pelagic_trawl')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS7 Pelagic trawl fisheries MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS7_Pelagic_trawl')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS7 Pelagic trawl fisheries EU MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### kW Fishing days by year

The first plot is showing the effort as kW Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.

```{r CS7kWFDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS7_Pelagic_trawl')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWFishDaysEU / kWFishDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWFishDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWFishDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU", 
       x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS7_Pelagic_trawl')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS7 Pelagic trawl fisheries EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS7_Pelagic_trawl')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS7 Pelagic trawl fisheries EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### N effort rows confidential

Number of rows marked as confidential by country and year in the FDI effort table (G). The CS is selected without countries to reflect the dataset that is available on EU level. 

```{r CS7nConf, fig.dim= c(6, 4)}
FDI_rows_confidential_sum7 <- FDI_rows_confidential_sum %>% filter(CSfleet=='CS7_Pelagic_trawl')

ggplot(FDI_rows_confidential_sum7, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col(position = "dodge") +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum7, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col() +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential stacked bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum7, aes(x = Year, y = Country, fill = n_rows)) +
  geom_tile() +
  facet_wrap(~ confidential) +
  scale_fill_viridis_c() +
  labs(title = paste("Number of rows confidential heatmap"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


ggplot(FDI_rows_confidential_sum7, aes(x = Year, y = Country, size = n_rows, color = confidential)) +
  geom_point(alpha = 0.7) +
   labs(title = paste("Number of rows confidential bubble chart"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```


### Vessel length

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS7FDVL, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS7_Pelagic_trawl') %>% group_by(Year, Vessel.Length.Category) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = paste("FDI fleet effort - CS7 Pelagic trawl fisheries EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS7_Pelagic_trawl') %>% group_by(Year, Country, Vessel.Length.Category) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS7 Pelagic trawl fisheries by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS7 Pelagic trawl fisheries by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS7 Pelagic trawl fisheries) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Vessel length grouped

In these plots the vessels below 12 m have been grouped, to avoid overlapping vesse length ranges.

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS7FDVLG, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS7_Pelagic_trawl') %>% group_by(Year, VL_GR) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = paste("FDI fleet effort - CS7 Pelagic trawl fisheries EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS7_Pelagic_trawl') %>% group_by(Year, Country, VL_GR) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS7 Pelagic trawl fisheries by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS7 Pelagic trawl fisheries by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS7 Pelagic trawl fisheries) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```


### Metier level 6

The metier level 6 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'_'Mesh size range'_'Selection devices'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 6 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS7FDMet, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS7_Pelagic_trawl') %>% group_by(Year, Metier) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(Metier = ifelse(Metier %in% top_metiers, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU (Top 10 Metiers)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metiers") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS7_Pelagic_trawl') %>% group_by(Year, Country, Metier) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(Metier %in% top_metiersMS, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS7 Pelagic trawl fisheries by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS7 Pelagic trawl fisheries by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS7 Pelagic trawl fisheries) – % Fishing days by Metier",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Metier level 5

The metier level 5 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 5 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS7FDMet5, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS7_Pelagic_trawl') %>% group_by(Year, metier_lvl5) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(metier_lvl5 = ifelse(metier_lvl5 %in% top_metiers, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS7 Pelagic trawl fisheries EU (Top 10 Metier level 5)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metier level 5") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet == "CS7_Pelagic_trawl") %>%  group_by(Year, Country, metier_lvl5) %>%
  summarise(FishingDaysMS = sum(Total.Fishing.Days, na.rm = TRUE), .groups = "drop")

# Top 10 metiers by total fishing days (no ties)
top_metiersMS <- CS_Metier_MS %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysMS, na.rm = TRUE), .groups = "drop") %>%
  slice_max(Total, n = 10, with_ties = FALSE) %>%   # ensures exactly 10
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(metier_lvl5 %in% top_metiersMS, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS7 Pelagic trawl fisheries by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS7 Pelagic trawl fisheries by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS7 Pelagic trawl fisheries) – % Fishing days by Metier level 5",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Quarter

Plots of fishing days by quarter and year (first plot) and by country (second plot)

```{r CS7FDQ, fig.dim= c(6, 4)}
CS_Quarter_EU <- effort_EU2 %>% filter(CSfleet == "CS7_Pelagic_trawl") %>%  group_by(Year, Quarter) %>%
  summarise(FishingDaysEU = sum(Total.Fishing.Days, na.rm = TRUE), .groups = "drop")

# Plot: quarterly patterns by year
ggplot(CS_Quarter_EU, aes(x = factor(Quarter), y = FishingDaysEU, 
                          group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Quarterly FDI fishing effort (CS7 Pelagic trawl fisheries)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

#by MS
CS_Quarter_MS <- effort_MS2 %>% filter(CSfleet=='CS7_Pelagic_trawl') %>% group_by(Year, Country, Quarter) %>%
  summarise(FishingDaysMS = sum(Total.Fishing.Days, na.rm =TRUE), .groups = "drop")

ggplot(CS_Quarter_MS, aes(x = factor(Quarter), y = FishingDaysMS, group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ Country) +
  labs(
    title = "Quarterly fishing effort by country (CS7 Pelagic trawl fisheries)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

```

### Maps

```{r CS7area, , echo=FALSE, out.width="80%", fig.cap="FDI EU CS7 Pelagic trawl effort, ICES areas (2023)"}

knitr::include_graphics("Q:/20-forskning/20-dfad/users/joeg/home/VMS/250318_CIBBRiNA/maps/CS7_FDI_EU_pelagic_trawl_2023_area.png")

```

```{r CS7rect, , echo=FALSE, out.width="80%", fig.cap="FDI EU CS7 Pelagic trawl effort, ICES rectangles (2023)"}

knitr::include_graphics("Q:/20-forskning/20-dfad/users/joeg/home/VMS/250318_CIBBRiNA/maps/CS7_FDI_EU_pelagic_trawl_2023_rectangle.png")

```
 
## CIBBRiNA Case Study 8: Demersal trawl fisheries in Greater North Sea {.tabset}

Gears: OTB, PTB, TBB

Areas: 27.3.a.20,27.4.b,27.4.c,27.7.d

Countries: Belgium,Netherlands


### Days at sea by year

The first plot is showing the effort as Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS8DASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS8_Demersal_trawl')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = SeaDaysEU / SeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = SeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(SeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$SeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EUU", 
       x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS8_Demersal_trawl')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS8_Demersal_trawl')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS"), x = "Year", y = "Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = SeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS",
       x = "Year", y = "Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### Fishing days by year


The first plot is showing the effort as Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS8FDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS8_Demersal_trawl')
# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = FishingDaysEU / FishingDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = FishingDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(FishingDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$FishingDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU", 
       x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS8_Demersal_trawl')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS8_Demersal_trawl')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = FishingDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS",
       x = "Year", y = "Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

### kW Days at sea by year

The first plot is showing the effort as kW Days at sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Days at sea by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.


```{r CS8kWDASYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS8_Demersal_trawl')

# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWSeaDaysEU / kWSeaDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWSeaDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWSeaDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Days at sea",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWSeaDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU", 
       x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS8_Demersal_trawl')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS8_Demersal_trawl')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS"), x = "Year", y = "kW Days at sea") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWSeaDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea MS",
       x = "Year", y = "kW Days at sea (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

### kW Fishing days by year

The first plot is showing the effort as kW Fishing days sea by year, when filtering the effort at EU level for the CIBBRiNA case study fleets. The EU level can only be filtered by gears and areas, and not by country.

The second plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. Therefore a part of the effort is missing in this plot.

The third plot is showing the effort as kW Fishing days by year, when filtering the effort at Country level for the CIBBRiNA case study fleets. The Country level is filtered by the CS countries, gears and areas. When submitting data to the FDI the country can mark data as confidential, typically if there are less than 3 vessels in the aggregation level of data submission. In this plot, the difference between the effort on EU level and the country level is added as 'Unknown'. This difference can be due to data marked as confidential, but can also be due to other MS than the ones defined in the case study have fishing effort in this fleet.

```{r CS8kWFDYear, fig.dim= c(6, 4)}
FDI_CS_fleet_EU <- FDI_fleet_EU %>% filter(CSfleet=='CS8_Demersal_trawl')
# First calculate index (base 2013 = 100)
FDI_CS_fleet_EU <- FDI_CS_fleet_EU %>%
  mutate(Index2013 = kWFishDaysEU / kWFishDaysEU[Year == 2013] * 100)

ggplot(FDI_CS_fleet_EU, aes(x = factor(Year))) +
  geom_bar(aes(y = kWFishDaysEU), stat = "identity", fill = "steelblue") +
  geom_line(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013), group = 1),
            color = "red", size = 1) +
  geom_point(aes(y = Index2013 * max(kWFishDaysEU) / max(Index2013)), 
             color = "red", size = 2) +
    # Primary and secondary axes
  scale_y_continuous(name = "kW Fishing days",sec.axis = sec_axis(~ . * max(FDI_CS_fleet_EU$Index2013) / max(FDI_CS_fleet_EU$kWFishDaysEU),name = "Index (2013 = 100)")) +
    labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU", 
       x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS <- FDI_fleet_MS %>% filter(CSfleet=='CS8_Demersal_trawl')
ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

FDI_CS_fleet_MS_tot <- FDI_fleet_MS_tot %>% filter(CSfleet=='CS8_Demersal_trawl')
ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill=Country)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = country_colors) +
  labs(title = paste("FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS"), x = "Year", y = "kW Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_CS_fleet_MS_tot, aes(x = factor(Year), y = kWFishDaysMS, fill = Country)) +
  geom_bar(stat = "identity", position = "fill") +   
  scale_y_continuous(labels = scales::percent) +     
  scale_fill_manual(values = country_colors) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU MS",
       x = "Year", y = "kW Fishing days (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### N effort rows confidential

Number of rows marked as confidential by country and year in the FDI effort table (G). The CS is selected without countries to reflect the dataset that is available on EU level. 

```{r CS8nConf, fig.dim= c(6, 4)}
FDI_rows_confidential_sum8 <- FDI_rows_confidential_sum %>% filter(CSfleet=='CS8_Demersal_trawl')

ggplot(FDI_rows_confidential_sum8, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col(position = "dodge") +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum8, aes(x = Year, y = n_rows, fill = confidential)) +
  geom_col() +
  facet_wrap(~ Country) +
  labs(title = paste("Number of rows confidential stacked bar chart"), x = "Year", y = "Number of rows") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(FDI_rows_confidential_sum8, aes(x = Year, y = Country, fill = n_rows)) +
  geom_tile() +
  facet_wrap(~ confidential) +
  scale_fill_viridis_c() +
  labs(title = paste("Number of rows confidential heatmap"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


ggplot(FDI_rows_confidential_sum8, aes(x = Year, y = Country, size = n_rows, color = confidential)) +
  geom_point(alpha = 0.7) +
   labs(title = paste("Number of rows confidential bubble chart"), x = "Year/Confidential", y = "Country") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

### Vessel length

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS8FDVL, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS8_Demersal_trawl') %>% group_by(Year, Vessel.Length.Category) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = paste("FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS8_Demersal_trawl') %>% group_by(Year, Country, Vessel.Length.Category) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - v by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Vessel.Length.Category)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS8 Demersal trawl fisheries in Greater North Sea) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Vessel length grouped

In these plots the vessels below 12 m have been grouped, to avoid overlapping vesse length ranges.

The first plot is showing the fishing days by vessel length categories within CS fleet at EU level. 

The second plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by vessel length categories within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS8FDVLG, fig.dim= c(6, 4)}
CS_VL_EU <- effort_EU2 %>% filter(CSfleet=='CS8_Demersal_trawl') %>% group_by(Year, VL_GR) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill=VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = paste("FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU"), x = "Year", y = "Fishing days") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(CS_VL_EU, aes(x = factor(Year), y = FishingDaysEU, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +   # 100% stacked bar
  scale_y_continuous(labels = scales::percent) +     # show y-axis in %
  scale_fill_manual(values = vessel_length_colors_reduced) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU", x = "Year", y = "Fishing days (%)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

CS_VL_MS <- effort_MS2 %>% filter(CSfleet=='CS8_Demersal_trawl') %>% group_by(Year, Country, VL_GR) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea by Country and Vessel Length",
    x = "Year",
    y = "Fishing days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_VL_MS, aes(x = factor(Year), y = FishingDaysMS, fill = VL_GR)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = vessel_length_colors_reduced) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS8 Demersal trawl fisheries in Greater North Sea) – % Fishing days by Vessel Length",
    x = "Year",
    y = "% Fishing Days",
    fill = "Vessel Length"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Metier level 6

The metier level 6 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'_'Mesh size range'_'Selection devices'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 6 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 6 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS8FDMet, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS8_Demersal_trawl') %>% group_by(Year, Metier) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(Metier = ifelse(Metier %in% top_metiers, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU (Top 10 Metiers)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metiers") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS8_Demersal_trawl') %>% group_by(Year, Country, Metier) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(Metier) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(Metier)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(Metier %in% top_metiersMS, Metier, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea by Country and Metier",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = Metier)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS8 Demersal trawl fisheries in Greater North Sea) – % Fishing days by Metier",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metiers"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Metier level 5

The metier level 5 is defined in the DCF EU-MAP and is managed by the RCG ISSG Metier and transversal variables, and used for reporting in FDI and ICES data calls. The code has the components 'Gear'_'Target species assemblage'. See more documentation at: https://github.com/ices-eg/RCGs/tree/master/Metiers.

Note: There can be a difference between the gears reported in the GEAR_TYPE variable and in the Metier code on level 4.

As there are many minor metier codes, only the top 10 metier codes by fishing days are shown in the plot below, the rest are grouped into 'Other'.

The first plot is showing the fishing days by metier level 5 within CS fleet at EU level. 

The second plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is not fixed. 

The third plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is fixed, so it is easier to get an overview of the relative fishing effort by MS. 

The fourth plot is showing the fishing days by metier level 5 within CS fleet at country level, where the y-axis is shown as percentage.


```{r CS8FDMet5, fig.dim= c(6, 4)}
CS_Metier_EU <- effort_EU2 %>% filter(CSfleet=='CS8_Demersal_trawl') %>% group_by(Year, metier_lvl5) %>%
  summarise(FishingDaysEU=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiers <- CS_Metier_EU %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysEU)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_EU <- CS_Metier_EU %>%
  mutate(metier_lvl5 = ifelse(metier_lvl5 %in% top_metiers, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiers
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_EU, aes(x = factor(Year), y = FishingDaysEU, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  labs(title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea EU (Top 10 Metier level 5)", 
       x = "Year", y = "Fishing days", fill = "Top 10 metier level 5") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#by MS
CS_Metier_MS <- effort_MS2 %>% filter(CSfleet=='CS8_Demersal_trawl') %>% group_by(Year, Country, metier_lvl5) %>%
  summarise(FishingDaysMS=sum(Total.Fishing.Days), na.rm=T)

# Find top 10 Metiers by total fishing days
top_metiersMS <- CS_Metier_MS %>%
  group_by(metier_lvl5) %>%
  summarise(Total = sum(FishingDaysMS)) %>%
  top_n(10, Total) %>%
  pull(metier_lvl5)

# Relabel others as "Other"
CS_Metier_MS <- CS_Metier_MS %>%
  mutate(Metier = ifelse(metier_lvl5 %in% top_metiersMS, metier_lvl5, "Other"))

# Define color vector
metier_colors <- setNames(
  RColorBrewer::brewer.pal(10, "Set3"),  # 10 distinct colors
  top_metiersMS
)
metier_colors["Other"] <- "#B0B0B0"  # Light grey for 'Other'

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_y") +
  labs(
    title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country) +
  labs(
    title = "FDI fleet effort - CS8 Demersal trawl fisheries in Greater North Sea by Country and Metier level 5",
    x = "Year",
    y = "Fishing days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

ggplot(CS_Metier_MS, aes(x = factor(Year), y = FishingDaysMS, fill = metier_lvl5)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = metier_colors) +
  facet_wrap(~ Country, scales = "free_x") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "FDI fleet effort (CS8 Demersal trawl fisheries in Greater North Sea) – % Fishing days by Metier level 5",
    x = "Year",
    y = "% Fishing Days",
    fill = "Top 10 metier level 5"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
    strip.text = element_text(face = "bold")
  )

```

### Quarter

Plots of fishing days by quarter and year (first plot) and by country (second plot)

```{r CS8FDQ, fig.dim= c(6, 4)}
CS_Quarter_EU <- effort_EU2 %>% filter(CSfleet == "CS8_Demersal_trawl") %>%  group_by(Year, Quarter) %>%
  summarise(FishingDaysEU = sum(Total.Fishing.Days, na.rm = TRUE), .groups = "drop")

# Plot: quarterly patterns by year
ggplot(CS_Quarter_EU, aes(x = factor(Quarter), y = FishingDaysEU, 
                          group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Quarterly FDI fishing effort (CS8 Demersal trawl fisheries in Greater North Sea)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

#by MS
CS_Quarter_MS <- effort_MS2 %>% filter(CSfleet=='CS8_Demersal_trawl') %>% group_by(Year, Country, Quarter) %>%
  summarise(FishingDaysMS = sum(Total.Fishing.Days, na.rm =TRUE), .groups = "drop")

ggplot(CS_Quarter_MS, aes(x = factor(Quarter), y = FishingDaysMS, group = Year, color = factor(Year))) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ Country) +
  labs(
    title = "Quarterly fishing effort by country (CS8 Demersal trawl fisheries in Greater North Sea)",
    x = "Quarter",
    y = "Fishing days",
    color = "Year"
  ) +
  theme_minimal()

```


### Maps

```{r CS8area, , echo=FALSE, out.width="80%", fig.cap="FDI EU CS8 Demersal trawl effort, ICES areas (2023)"}

knitr::include_graphics("Q:/20-forskning/20-dfad/users/joeg/home/VMS/250318_CIBBRiNA/maps/CS8_FDI_EU_demersal_trawl_2023_area.png")

```

```{r CS8rect, , echo=FALSE, out.width="80%", fig.cap="FDI EU CS8 Demersal trawl effort, ICES rectangles (2023)"}

knitr::include_graphics("Q:/20-forskning/20-dfad/users/joeg/home/VMS/250318_CIBBRiNA/maps/CS8_FDI_EU_demersal_trawl_2023_rectangle.png")

```
